(defpackage :terraria-map-dump.map-tile
  (:use :common-lisp)
  (:export :copy-tile-with-light :fluid-tile :ground-tile :honey-tile :lava-tile
           :make-ground-tile :make-honey-tile :make-lava-tile :make-sky-tile
           :make-unknown-tile :make-wall-tile :make-water-tile :make-world-tile
           :map-tile :sky-tile :tile-id :tile-light-level :tile-raw-color
           :tile-variation :unknown-tile :wall-tile :water-tile :world-tile))
(in-package :terraria-map-dump.map-tile)

(defgeneric copy-tile-with-light (tile new-light))
(defgeneric tile-id (tile))
(defgeneric tile-light-level (tile))
(defgeneric tile-raw-color (tile))
(defgeneric tile-variation (tile))

(defstruct map-tile
  (color 0 :type (unsigned-byte 7) :read-only t)
  (light 255 :type (unsigned-byte 8) :read-only t))
(defmethod tile-raw-color ((tile map-tile))
  (map-tile-color tile))
(defmethod tile-light-level ((this map-tile))
  (map-tile-light tile))
(defstruct (unknown-tile (:include map-tile
                                   (light 0 :type (unsigned-byte 8) :read-only t))))
(defmethod copy-tile-with-light ((tile unknown-tile) new-light)
  (make-unknown-tile :color (unknown-tile-color tile)
                     :light (unknown-tile-light tile)))
(defstruct (type-variation-tile (:include map-tile))
  (id 0 :type (unsigned-byte 16) :read-only t)
  (variation 0 :type (unsigned-byte 8) :read-only t))
(defmethod tile-id ((tile type-variation-tile))
  (type-variation-tile-id tile))
(defmethod tile-variation ((tile type-variation-tile))
  (type-variation-tile-variation tile))
(defstruct (world-tile (:include type-variation-tile)))
(defmethod copy-tile-with-light ((tile world-tile) new-light)
  (make-world-tile :color (world-tile-color tile)
                   :light (world-tile-light tile)
                   :id (world-tile-id tile)
                   :variation (world-tile-variation tile)))
(defstruct (wall-tile (:include type-variation-tile)))
(defmethod copy-tile-with-light ((tile wall-tile) new-light)
  (make-wall-tile :color (wall-tile-color tile)
                  :light (wall-tile-light tile)
                  :id (wall-tile-id tile)
                  :variation (wall-tile-variation tile)))
(defstruct (fluid-tile (:include map-tile)))
(defstruct (water-tile (:include fluid-tile)))
(defmethod copy-tile-with-light ((tile water-tile) new-light)
  (make-water-tile :color (water-tile-color tile)
                   :light (water-tile-light tile)))
(defstruct (lava-tile (:include fluid-tile)))
(defmethod copy-tile-with-light ((tile lava-tile) new-light)
  (make-lava-tile :color (lava-tile-color tile)
                  :light (lava-tile-light tile)))
(defstruct (honey-tile (:include fluid-tile)))
(defmethod copy-tile-with-light ((tile honey-tile) new-light)
  (make-honey-tile :color (honey-tile-color tile)
                   :light (honey-tile-light tile)))
(defstruct (variation-tile (:include map-tile))
  (variation 0 :type (unsigned-byte 16) :read-only t))
(defmethod tile-variation ((tile variation-tile))
  (variation-tile-variation tile))
(defstruct (sky-tile (:include variation-tile)))
(defmethod copy-tile-with-light ((tile sky-tile) new-light)
  (make-sky-tile :color (sky-tile-color tile)
                 :light (sky-tile-light tile)
                 :variation (sky-tile-variation tile)))
(defstruct (ground-tile (:include variation-tile)))
(defmethod copy-tile-with-light ((tile ground-tile) new-light)
  (make-ground-tile :color (ground-tile-color tile)
                    :light (ground-tile-light tile)
                    :variation (ground-tile-variation tile)))
